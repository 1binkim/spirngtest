<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.CheckoutMapper">
<!-- orders 인서트 (seq_orders 트리거로 PK 세팅 가정) -->
  <insert id="insertOrder" parameterType="map">
    INSERT INTO orders (user_id, status, total_amount, address, postcode)
    VALUES (#{userId,jdbcType=NUMERIC}, #{status}, #{totalAmount}, #{address}, #{postcode})
  </insert>

  <!-- 같은 세션에서 직전에 NEXTVAL 사용되었다는 가정 하에 CURRVAL 회수 -->
  <select id="selectCurrOrderId" resultType="long">
    SELECT seq_orders.CURRVAL FROM dual
  </select>

  <!-- order_items 인서트 (seq_order_items 트리거로 PK 세팅 가정) -->
  <insert id="insertOrderItem" parameterType="map">
    INSERT INTO order_items (order_id, book_id, quantity, unit_price)
    VALUES (#{orderId}, #{bookId}, #{quantity}, #{unitPrice})
  </insert>
  
    <!-- 완료 화면: 주문 헤더 조회 -->
  <select id="findOrderById" parameterType="long" resultType="map">
    SELECT
      order_id   AS orderId,
      user_id    AS userId,
      status,
      total_amount AS totalAmount,
      address,
      postcode
    FROM orders
    WHERE order_id = #{orderId}
  </select>

  <!-- 완료 화면: 주문 항목 + 책 제목 조회 -->
  <select id="findOrderItemsByOrderId" parameterType="long" resultType="map">
    SELECT
      oi.order_item_id AS orderItemId,
      oi.order_id      AS orderId,
      oi.book_id       AS bookId,
      b.title          AS bookTitle,
      oi.quantity      AS quantity,
      oi.unit_price    AS unitPrice
    FROM order_items oi
    JOIN books b ON b.book_id = oi.book_id
    WHERE oi.order_id = #{orderId}
    ORDER BY oi.order_item_id
  </select>
</mapper>